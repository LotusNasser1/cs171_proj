<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Economic Mobility: A Data Story</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Garamond','Georgia',serif;background:#f4e8d0;color:#2c1810}
    body::before{content:'';position:fixed;inset:0;background-image:repeating-linear-gradient(0deg,rgba(139,89,42,.03) 0px,transparent 1px,transparent 2px,rgba(139,89,42,.03) 3px);pointer-events:none;z-index:1}
    #scroll-container{position:relative;z-index:2}
    .step{min-height:100vh;display:flex;align-items:center;padding:20px;opacity:.4;transition:opacity .6s ease}
    .step.active{opacity:1}
    .step-content{max-width:500px;background:rgba(244,232,208,.95);padding:50px 40px;border:2px solid #8b5a2b;box-shadow:0 2px 8px rgba(0,0,0,.15),inset 0 0 100px rgba(139,89,42,.05);position:relative;margin-left:60px}
    .step-content::before,.step-content::after{content:'';position:absolute;width:20px;height:20px;border:2px solid #8b5a2b}
    .step-content::before{top:10px;left:10px;border-right:none;border-bottom:none}
    .step-content::after{bottom:10px;right:10px;border-left:none;border-top:none}
    .step-content h2{font-size:2.2em;margin-bottom:25px;color:#2c1810;line-height:1.3;font-weight:600;letter-spacing:.5px;border-bottom:2px solid #8b5a2b;padding-bottom:15px}
    .step-content p{font-size:1.15em;line-height:1.9;color:#3d2817;margin-bottom:15px}
    .highlight{color:#1a5f4a;font-weight:bold;background:rgba(26,95,74,.08);padding:2px 6px;border-radius:2px}
    .highlight-negative{color:#8b2e2e;font-weight:bold;background:rgba(139,46,46,.08);padding:2px 6px;border-radius:2px}

    #visualization{position:fixed;top:0;right:0;width:55%;height:100vh;pointer-events:none;z-index:10;display:flex;align-items:center;justify-content:center;transition:opacity .35s ease, transform .35s ease}
    #visualization.hidden{opacity:0;transform:scale(.98)}
    #viz-svg{width:90%;height:90%;background:rgba(255,255,255,.6);border:3px solid #8b5a2b;box-shadow:0 4px 12px rgba(0,0,0,.2),inset 0 0 100px rgba(139,89,42,.03)}

    .intro{min-height:100vh;display:flex;align-items:center;justify-content:center;text-align:center;background:linear-gradient(135deg,rgba(139,89,42,.15) 0%,rgba(205,173,127,.15) 100%),#f4e8d0;position:relative;z-index:2}
    .intro-content{max-width:800px;padding:60px;background:rgba(244,232,208,.95);border:3px solid #8b5a2b;box-shadow:0 8px 24px rgba(0,0,0,.25),inset 0 0 100px rgba(139,89,42,.05);position:relative}
    .intro-content::before,.intro-content::after{content:'';position:absolute;width:30px;height:30px;border:3px solid #8b5a2b}
    .intro-content::before{top:15px;left:15px;border-right:none;border-bottom:none}
    .intro-content::after{bottom:15px;right:15px;border-left:none;border-top:none}
    .intro h1{font-size:3.5em;margin-bottom:25px;color:#2c1810;font-weight:700;letter-spacing:1px;line-height:1.2}
    .intro p{font-size:1.4em;color:#3d2817;line-height:1.7;font-style:italic}
    .scroll-indicator{position:absolute;bottom:40px;left:50%;transform:translateX(-50%);animation:bounce 2s infinite}
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateX(-50%) translateY(0)}40%{transform:translateX(-50%) translateY(-20px)}60%{transform:translateX(-50%) translateY(-10px)}}
    .arrow-down{font-size:2.5em;color:#8b5a2b}

    .outro{min-height:100vh;display:flex;align-items:center;justify-content:center;text-align:center;background:linear-gradient(135deg,rgba(139,89,42,.2) 0%,rgba(205,173,127,.2) 100%),#f4e8d0;padding:40px;position:relative;z-index:2}
    .outro-content{max-width:900px;padding:60px;background:rgba(244,232,208,.95);border:3px solid #8b5a2b;box-shadow:0 8px 24px rgba(0,0,0,.25),inset 0 0 100px rgba(139,89,42,.05);position:relative}
    .outro-content::before,.outro-content::after{content:'';position:absolute;width:30px;height:30px;border:3px solid #8b5a2b}
    .outro-content::before{top:15px;left:15px;border-right:none;border-bottom:none}
    .outro-content::after{bottom:15px;right:15px;border-left:none;border-top:none}
    .outro h2{font-size:3em;margin-bottom:35px;color:#2c1810;font-weight:700;border-bottom:3px solid #8b5a2b;padding-bottom:20px}
    .outro p{font-size:1.3em;color:#3d2817;line-height:1.9;margin-bottom:20px}

    @media (max-width:1024px){
      #visualization{position:relative;width:100%;height:400px;margin:20px 0}
      #viz-svg{width:95%;height:95%}
      .step-content{max-width:100%;margin-inline:20px}
      .step{display:block}
    }
  </style>
</head>
<body>
  <div class="intro">
    <div class="intro-content">
      <h1>What Really Drives Economic Mobility?</h1>
      <p>A data-driven examination of the factors that shape opportunity in America</p>
      <div class="scroll-indicator"><div class="arrow-down">↓</div></div>
    </div>
  </div>

  <!-- fixed panel (hidden during intro & outro) -->
  <div id="visualization" class="hidden">
    <svg id="viz-svg" aria-label="Scrollytelling visualization"></svg>
  </div>

  <div id="scroll-container">
    <div class="step" data-step="0">
      <div class="step-content">
        <h2>The American Dream?</h2>
        <p>We often hear that <span class="highlight">hard work</span> and <span class="highlight">economic growth</span> are the keys to upward mobility. But what does the data actually tell us?</p>
      </div>
    </div>

    <div class="step" data-step="1">
      <div class="step-content">
        <h2>The Myth of Job Growth</h2>
        <p>Correlation: <span class="highlight-negative">+0.05</span></p>
        <p>Cities with booming job markets don't necessarily create better outcomes for children from low-income families. The relationship is virtually non-existent.</p>
      </div>
    </div>

    <div class="step" data-step="2">
      <div class="step-content">
        <h2>Higher Wages Aren't Enough</h2>
        <p>Correlation: <span class="highlight-negative">+0.08</span></p>
        <p>Even rising wages in an area show minimal impact on long-term economic mobility. The problem runs deeper than paychecks.</p>
      </div>
    </div>

    <div class="step" data-step="3">
      <div class="step-content">
        <h2>The Reality: Poverty Matters</h2>
        <p>Correlation: <span class="highlight-negative">-0.55</span></p>
        <p>Areas with higher poverty rates show <span class="highlight-negative">significantly lower mobility</span>. Concentrated poverty creates powerful barriers that persist across generations.</p>
      </div>
    </div>

    <div class="step" data-step="4">
      <div class="step-content">
        <h2>Education Opens Doors</h2>
        <p>Correlation: <span class="highlight">+0.52</span></p>
        <p>Communities with more college-educated adults provide better opportunities for <span class="highlight">all children</span> in the area—not just their own.</p>
      </div>
    </div>

    <div class="step" data-step="5">
      <div class="step-content">
        <h2>Family Stability</h2>
        <p>Correlation: <span class="highlight">+0.48</span></p>
        <p>Areas with more stable family structures show significantly better mobility outcomes, even after controlling for income levels.</p>
      </div>
    </div>

    <div class="step" data-step="6">
      <div class="step-content">
        <h2>Environmental Justice</h2>
        <p>Correlation: <span class="highlight-negative">-0.42</span></p>
        <p>Even <span class="highlight-negative">air quality</span> affects economic outcomes. Higher pollution levels correlate with lower mobility—environmental injustice becomes economic injustice.</p>
      </div>
    </div>

    <div class="step" data-step="7">
      <div class="step-content">
        <h2>Community Roots</h2>
        <p>Correlation: <span class="highlight">+0.36</span></p>
        <p>Higher homeownership rates indicate community stability, which benefits children's long-term economic prospects.</p>
      </div>
    </div>
  </div>

  <div class="outro">
    <div class="outro-content">
      <h2>The Takeaway</h2>
      <p>Economic mobility isn't just about jobs and wages. It's shaped by <span class="highlight">social structures</span>, <span class="highlight">community resources</span>, and <span class="highlight">environmental conditions</span> that create—or limit—opportunity.</p>
      <p style="margin-top:30px;font-style:italic">Understanding these connections is the first step toward building more equitable communities.</p>
    </div>
  </div>

  <script>
    /* ---------- Step metadata (1:1 with panels) ---------- */
    const stepsData = [
      { title:'The American Dream?',     type:'title',   correlation:0,     axisX:'' },
      { title:'The Myth of Job Growth',  type:'scatter', correlation: 0.05, color:'#8b5a2b', axisX:'Job growth (%)' },
      { title:"Higher Wages Aren't Enough", type:'scatter', correlation: 0.08, color:'#8b5a2b', axisX:'Wage growth (%)' },
      { title:'The Reality: Poverty Matters', type:'scatter', correlation:-0.55, color:'#8b2e2e', axisX:'Poverty rate (%)' },
      { title:'Education Opens Doors',   type:'scatter', correlation: 0.52, color:'#1a5f4a', axisX:'Adults with college degree (%)' },
      { title:'Family Stability',        type:'scatter', correlation: 0.48, color:'#1a5f4a', axisX:'Two-parent households (%)' },
      { title:'Environmental Justice',   type:'scatter', correlation:-0.42, color:'#8b2e2e', axisX:'PM2.5 (μg/m³)' },
      { title:'Community Roots',         type:'scatter', correlation: 0.36, color:'#1a5f4a', axisX:'Homeownership (%)' }
    ];

    /* ---------- SVG setup ---------- */
    const svg = d3.select("#viz-svg");
    const margin = { top:80, right:60, bottom:70, left:70 };
    let width, height, chartWidth, chartHeight;

    function updateDimensions(){
      const el = document.getElementById('viz-svg');
      width = el.clientWidth; height = el.clientHeight;
      chartWidth  = Math.max(0, width  - margin.left - margin.right);
      chartHeight = Math.max(0, height - margin.top  - margin.bottom);
    }
    updateDimensions();

    const chartGroup = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
    const xScale = d3.scaleLinear().domain([0,100]).range([0, chartWidth]);
    const yScale = d3.scaleLinear().domain([-60,60]).range([chartHeight, 0]);

    const xAxisGroup = chartGroup.append("g").attr("class","x-axis").attr("transform", `translate(0,${chartHeight})`);
    const yAxisGroup = chartGroup.append("g").attr("class","y-axis");

    const xLabel = chartGroup.append("text")
      .attr("class","x-label").attr("text-anchor","middle")
      .attr("x", chartWidth/2).attr("y", chartHeight+50)
      .style("font-size","16px").style("font-family","'Garamond','Georgia',serif").style("fill","#2c1810").style("font-weight","600");

    const yLabel = chartGroup.append("text")
      .attr("class","y-label").attr("text-anchor","middle")
      .attr("transform","rotate(-90)").attr("x", -chartHeight/2).attr("y", -50)
      .style("font-size","16px").style("font-family","'Garamond','Georgia',serif").style("fill","#2c1810").style("font-weight","600")
      .text("Economic Mobility Index");

    const correlationText = chartGroup.append("text")
      .attr("class","correlation-display").attr("x", chartWidth/2).attr("y", -35).attr("text-anchor","middle")
      .style("font-size","42px").style("font-family","'Garamond','Georgia',serif").style("font-weight","bold").style("opacity",0);

    /* ---------- Deterministic, cached data per step ---------- */
    const cachedData = new Map();

    function mulberry32(seed){
      return function(){
        seed |= 0; seed = seed + 0x6D2B79F5 | 0;
        let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
        t = (t + Math.imul(t ^ t >>> 7, 61 | t)) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }
    function hashInt(str){
      let h = 2166136261;
      for (let i=0; i<str.length; i++) { h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
      return h|0;
    }
    function boxMuller(prng){
      const u1 = Math.max(Number.MIN_VALUE, prng());
      const u2 = prng();
      const R = Math.sqrt(-2 * Math.log(u1));
      const theta = 2 * Math.PI * u2;
      return R * Math.cos(theta);
    }
    function generateCorrelatedData(r, n, seed){
      const prng = mulberry32(seed);
      const X=[],Y=[];
      for (let i=0;i<n;i++){
        const z1 = boxMuller(prng);
        const z2 = boxMuller(prng);
        const x  = z1;
        const y  = r * z1 + Math.sqrt(1 - r*r) * z2;
        X.push(x); Y.push(y);
      }
      const mean = a => a.reduce((s,v)=>s+v,0)/a.length;
      const std  = (a,m) => Math.sqrt(a.reduce((s,v)=>s+(v-m)*(v-m),0)/a.length) || 1;
      const mx = mean(X), my = mean(Y);
      const sx = std(X,mx), sy = std(Y,my);
      const Xz = X.map(v => (v-mx)/sx);
      const Yz = Y.map(v => (v-my)/sy);
      const minX = Math.min(...Xz), maxX = Math.max(...Xz);
      const minY = Math.min(...Yz), maxY = Math.max(...Yz);
      const data = [];
      for (let i=0;i<n;i++){
        const xScaled = ((Xz[i]-minX)/(maxX-minX))*100;     // [0,100]
        const yScaled = ((Yz[i]-minY)/(maxY-minY))*120 - 60;// [-60,60]
        data.push({x:xScaled,y:yScaled});
      }
      return data;
    }
    function regressionLine(data){
      const n=data.length;
      let sumX=0,sumY=0,sumXY=0,sumX2=0;
      for (const p of data){ sumX+=p.x; sumY+=p.y; sumXY+=p.x*p.y; sumX2+=p.x*p.x; }
      const slope = (n*sumXY - sumX*sumY)/(n*sumX2 - sumX*sumX);
      const intercept = (sumY - slope*sumX)/n;
      return [{x:0,y:intercept},{x:100,y:slope*100 + intercept}];
    }

    const vizPanel = document.getElementById('visualization');
    function setVizVisible(on){ vizPanel.classList.toggle('hidden', !on); }

    let currentStep = -1;

    function updateVisualization(stepIndex){
      const step = stepsData[stepIndex];

      xScale.range([0, chartWidth]);
      yScale.range([chartHeight, 0]);

      if (!step || step.type === 'title'){
        setVizVisible(false);
        chartGroup.selectAll(".dot").remove();
        chartGroup.selectAll(".regression-line").remove();
        correlationText.transition().duration(200).style("opacity",0);
        xAxisGroup.transition().duration(200).style("opacity",0);
        yAxisGroup.transition().duration(200).style("opacity",0);
        xLabel.transition().duration(200).style("opacity",0);
        yLabel.transition().duration(200).style("opacity",0);
        return;
      }

      setVizVisible(true);

      const xAxis = d3.axisBottom(xScale).ticks(5);
      const yAxis = d3.axisLeft(yScale).ticks(5);
      xAxisGroup.transition().duration(450).style("opacity",1).call(xAxis)
        .attr("transform", `translate(0,${chartHeight})`);
      yAxisGroup.transition().duration(450).style("opacity",1).call(yAxis);

      xAxisGroup.selectAll("line, path").style("stroke","#8b5a2b").style("stroke-width","2px");
      yAxisGroup.selectAll("line, path").style("stroke","#8b5a2b").style("stroke-width","2px");
      xAxisGroup.selectAll("text").style("fill","#2c1810").style("font-family","'Garamond','Georgia',serif").style("font-size","13px");
      yAxisGroup.selectAll("text").style("fill","#2c1810").style("font-family","'Garamond','Georgia',serif").style("font-size","13px");

      xLabel.transition().duration(450)
        .style("opacity",1)
        .attr("x", chartWidth/2)
        .attr("y", chartHeight + 50)
        .text(step.axisX || step.title);
      yLabel.transition().duration(450).style("opacity",1);

      // deterministic data per step (cached)
      let data = cachedData.get(stepIndex);
      if (!data){
        const seed = hashInt(step.title + '|' + step.correlation);
        data = generateCorrelatedData(step.correlation, 90, seed);
        cachedData.set(stepIndex, data);
      }
      const lineData = regressionLine(data);

      const corrStr = step.correlation >= 0 ? `+${step.correlation.toFixed(2)}` : step.correlation.toFixed(2);
      correlationText
        .transition().duration(450)
        .style("opacity",1).style("fill", step.color)
        .attr("x", chartWidth/2)
        .text(`r = ${corrStr}`);

      const lineGen = d3.line().x(d => xScale(d.x)).y(d => yScale(d.y));
      const line = chartGroup.selectAll(".regression-line").data([lineData]);
      line.exit().remove();
      line.enter().append("path").attr("class","regression-line")
        .merge(line)
        .transition().duration(700)
        .attr("d", lineGen)
        .style("fill","none").style("stroke", step.color).style("stroke-width",3).style("opacity",.75);

      const dots = chartGroup.selectAll(".dot").data(data, (d,i)=>i);
      dots.exit().transition().duration(200).attr("r",0).remove();
      const dotsEnter = dots.enter().append("circle")
        .attr("class","dot")
        .attr("cx", d => xScale(d.x)).attr("cy", d => yScale(d.y))
        .attr("r", 0)
        .style("fill", step.color).style("opacity", .55).style("stroke", step.color).style("stroke-width", 1.5);
      dotsEnter.merge(dots)
        .transition().duration(700).delay((d,i)=>i*5)
        .attr("cx", d => xScale(d.x)).attr("cy", d => yScale(d.y))
        .attr("r", 5)
        .style("fill", step.color).style("stroke", step.color);
    }

    /* ---------- Robust step activation (IntersectionObserver) ---------- */
    const stepEls = Array.from(document.querySelectorAll('.step'));
    const io = new IntersectionObserver((entries)=>{
      // pick the most visible intersecting step
      const visible = entries.filter(e => e.isIntersecting);
      if (visible.length === 0) return;

      visible.sort((a,b)=> b.intersectionRatio - a.intersectionRatio);
      const el = visible[0].target;
      const idx = parseInt(el.dataset.step, 10); // 0..7 maps directly to stepsData[0..7]

      // toggle active classes
      stepEls.forEach(s => s.classList.toggle('active', s === el));

      if (idx !== currentStep) {
        currentStep = idx;
        updateVisualization(idx);
      }
    }, {
      root:null,
      threshold:[0.55, 0.6, 0.65, 0.7, 0.75] // switch when step is mostly in view
    });

    stepEls.forEach(el => io.observe(el));

    // Hide viz entirely when no step is visible (e.g., outro fully on screen)
    function hideIfNoStepVisible(){
      const anyVisible = stepEls.some(el => {
        const r = el.getBoundingClientRect();
        const vh = window.innerHeight || document.documentElement.clientHeight;
        const overlap = Math.max(0, Math.min(r.bottom, vh) - Math.max(r.top, 0));
        return overlap / Math.min(vh, r.height) >= 0.55;
      });
      setVizVisible(anyVisible && stepsData[currentStep] && stepsData[currentStep].type !== 'title');
    }

    window.addEventListener('scroll', hideIfNoStepVisible, { passive:true });

    // Resize: recompute layout but DO NOT regenerate data
    window.addEventListener('resize', () => {
      updateDimensions();
      updateVisualization(currentStep >= 0 ? currentStep : 0);
      hideIfNoStepVisible();
    });

    // Init (keep viz hidden at start)
    currentStep = 0;            // first .step is the title card inside the stack
    updateVisualization(currentStep);
    hideIfNoStepVisible();
  </script>
</body>
</html>