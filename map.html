<html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Vegetation & Economic Mobility in the U.S.</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <style>
    /* ======= PARCHMENT THEME ======= */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Garamond','Georgia',serif;
      background:#f4e8d0;color:#2c1810;min-height:100vh;
    }
    body::before{
      content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
      background-image:repeating-linear-gradient(
        0deg, rgba(139,89,42,.03) 0px, transparent 1px, transparent 2px, rgba(139,89,42,.03) 3px
      );
    }
    header{position:relative;z-index:2;padding:48px 24px 16px;text-align:center}
    header .frame{
      display:inline-block;max-width:1000px;width:100%;background:rgba(244,232,208,.95);
      padding:28px 24px;border:3px solid #8b5a2b;position:relative;
      box-shadow:0 8px 24px rgba(0,0,0,.18), inset 0 0 100px rgba(139,89,42,.05);
    }
    header .frame::before,header .frame::after{
      content:'';position:absolute;width:30px;height:30px;border:3px solid #8b5a2b;
    }
    header .frame::before{top:12px;left:12px;border-right:none;border-bottom:none}
    header .frame::after{bottom:12px;right:12px;border-left:none;border-top:none}
    h1{font-size:2.6rem;line-height:1.2;margin-bottom:10px;letter-spacing:.5px}
    p.sub{font-size:1.15rem;color:#3d2817;font-style:italic}

    .container{
      position:relative;z-index:2;display:grid;grid-template-columns:1fr 1fr;gap:26px;
      max-width:1200px;margin:26px auto 50px;padding:0 20px;
    }
    @media (max-width:980px){.container{grid-template-columns:1fr}}
    .card{
      background:rgba(255,255,255,.6);border:3px solid #8b5a2b;position:relative;
      box-shadow:0 4px 12px rgba(0,0,0,.2), inset 0 0 100px rgba(139,89,42,.03);
      padding:18px 18px 10px;
    }
    .card h2{font-size:1.6rem;margin:4px 4px 12px;border-bottom:2px solid #8b5a2b;padding-bottom:8px}

    .map-wrap{position:relative;width:100%;height:560px}
    @media (max-width:520px){.map-wrap{height:420px}}
    svg{width:100%;height:100%;display:block}
    .state{stroke:#2c1810;stroke-opacity:.4;stroke-width:.6px;shape-rendering:geometricPrecision}
    .state:hover{stroke-width:1.4px;stroke-opacity:.85}

    .legend{
      position:absolute;left:16px;bottom:14px;background:rgba(244,232,208,.93);
      border:2px solid #8b5a2b;padding:10px 12px;
      box-shadow:0 2px 8px rgba(0,0,0,.15), inset 0 0 60px rgba(139,89,42,.04);
      font-size:.95rem;
    }
    .legend h3{font-size:1rem;margin-bottom:8px}
    .legend .scale{
      width:220px;height:12px;margin:4px 0 6px;border:1px solid #8b5a2b;
      background:linear-gradient(to right, var(--from), var(--to));
    }
    .legend .ticks{display:flex;justify-content:space-between;font-size:.85rem;color:#3d2817}

    .tooltip{
      position:fixed;pointer-events:none;z-index:5;transform:translate(-50%,-110%);
      background:#fffdf8;border:2px solid #8b5a2b;padding:8px 10px;font-size:.95rem;color:#2c1810;
      box-shadow:0 6px 18px rgba(0,0,0,.22);display:none;white-space:nowrap;
    }

    .note{margin:10px 4px 0;color:#3d2817;font-size:.95rem;line-height:1.5}

    .stats{
      max-width:1200px;margin:0 auto 36px;padding:0 20px;text-align:center;color:#3d2817;
    }
    .stats .panel{
      display:inline-block;padding:14px 16px;margin:6px;background:rgba(244,232,208,.95);
      border:2px solid #8b5a2b;box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    .stats .panel b{color:#1a5f4a}
  </style>
</head>
<body>
  <header>
    <div class="frame">
      <h1>Where Green Meets Opportunity</h1>
      <p class="sub">A side-by-side look at U.S. vegetation and economic mobility</p>
    </div>
  </header>

  <section class="stats">
    <div class="panel">Correlation (Vegetation vs. Mobility): <b id="corr">—</b></div>
    <div class="panel">Hover a state to compare values across both maps.</div>
  </section>

  <main class="container">
    <!-- Vegetation -->
    <section class="card">
      <h2>Vegetation (NDVI / Tree Cover)</h2>
      <div class="map-wrap" id="map-veg">
        <svg aria-label="Vegetation map of the United States"></svg>
        <!-- pure green legend -->
        <div class="legend" id="legend-veg" style="--from:#f0f9ec; --to:#1a5e20">
          <h3>Vegetation</h3>
          <div class="scale"></div>
          <div class="ticks"><span id="veg-min">low</span><span id="veg-mid">median</span><span id="veg-max">high</span></div>
        </div>
      </div>
      <p class="note">
        Tip: use a normalized index like <em>NDVI</em> (0–1) or percent tree cover (0–100). Higher is greener.
      </p>
    </section>

    <!-- Mobility -->
    <section class="card">
      <h2>Economic Mobility (Rank of Children from Low-Income Families)</h2>
      <div class="map-wrap" id="map-mob">
        <svg aria-label="Economic mobility map of the United States"></svg>
        <div class="legend" id="legend-mob" style="--from:#e8ecfd; --to:#213b9a">
          <h3>Mobility (Rank)</h3>
          <div class="scale"></div>
          <div class="ticks"><span id="mob-min">low</span><span id="mob-mid">median</span><span id="mob-max">high</span></div>
        </div>
      </div>
      <p class="note">
        A common metric: <em>average income rank at age 35 for children from the 25th percentile</em>. Higher is better.
      </p>
    </section>
  </main>

  <div class="tooltip" id="tooltip"></div>

  <script>
    // ---------- CONFIG: point these to your CSVs ----------
    const paths = {
      vegetationCSV: 'vegetation.csv', // columns: state, vegetation
      mobilityCSV:   'mobility.csv'   // columns: state, mobility
    };

    // ---------- Map + color scales ----------
    const width = 960, height = 580;
    const projection = d3.geoAlbersUsa().translate([width/2, height/2]).scale(1200);
    const path = d3.geoPath(projection);

    // PURE GREEN for vegetation, BLUES for mobility
    const colorVeg = d3.scaleSequential().interpolator(d3.interpolateGreens);
    const colorMob = d3.scaleSequential().interpolator(d3.interpolateBlues);

    const $tip = d3.select('#tooltip');

    // Fallback mini data so page renders before you add files
    const fallbackVeg = [
      {state:'CA', vegetation:0.38},{state:'OR', vegetation:0.62},{state:'WA', vegetation:0.66},
      {state:'AZ', vegetation:0.21},{state:'UT', vegetation:0.31},{state:'CO', vegetation:0.45},
      {state:'TX', vegetation:0.32},{state:'FL', vegetation:0.54},{state:'NY', vegetation:0.52},
      {state:'GA', vegetation:0.49},{state:'NC', vegetation:0.51},{state:'MA', vegetation:0.53}
    ];
    const fallbackMob = [
      {state:'CA', mobility:56},{state:'OR', mobility:58},{state:'WA', mobility:62},
      {state:'AZ', mobility:49},{state:'UT', mobility:64},{state:'CO', mobility:61},
      {state:'TX', mobility:50},{state:'FL', mobility:52},{state:'NY', mobility:59},
      {state:'GA', mobility:48},{state:'NC', mobility:51},{state:'MA', mobility:66}
    ];

    // State name/code normalization
    const stateMap = new Map([
      ['AL','Alabama'],['AK','Alaska'],['AZ','Arizona'],['AR','Arkansas'],['CA','California'],['CO','Colorado'],
      ['CT','Connecticut'],['DE','Delaware'],['FL','Florida'],['GA','Georgia'],['HI','Hawaii'],['ID','Idaho'],
      ['IL','Illinois'],['IN','Indiana'],['IA','Iowa'],['KS','Kansas'],['KY','Kentucky'],['LA','Louisiana'],
      ['ME','Maine'],['MD','Maryland'],['MA','Massachusetts'],['MI','Michigan'],['MN','Minnesota'],['MS','Mississippi'],
      ['MO','Missouri'],['MT','Montana'],['NE','Nebraska'],['NV','Nevada'],['NH','New Hampshire'],['NJ','New Jersey'],
      ['NM','New Mexico'],['NY','New York'],['NC','North Carolina'],['ND','North Dakota'],['OH','Ohio'],
      ['OK','Oklahoma'],['OR','Oregon'],['PA','Pennsylvania'],['RI','Rhode Island'],['SC','South Carolina'],
      ['SD','South Dakota'],['TN','Tennessee'],['TX','Texas'],['UT','Utah'],['VT','Vermont'],['VA','Virginia'],
      ['WA','Washington'],['WV','West Virginia'],['WI','Wisconsin'],['WY','Wyoming'],['DC','District of Columbia']
    ]);
    const name2code = new Map(Array.from(stateMap, ([k,v]) => [v.toLowerCase(), k]));
    function normalizeState(s){
      if(!s) return null;
      const t = String(s).trim();
      if (stateMap.has(t.toUpperCase())) return t.toUpperCase();
      const code = name2code.get(t.toLowerCase());
      return code || null;
    }

    // FIPS → USPS code for us-atlas topology
    const FIPS2USPS = new Map([
      [1,'AL'],[2,'AK'],[4,'AZ'],[5,'AR'],[6,'CA'],[8,'CO'],[9,'CT'],[10,'DE'],[11,'DC'],[12,'FL'],[13,'GA'],
      [15,'HI'],[16,'ID'],[17,'IL'],[18,'IN'],[19,'IA'],[20,'KS'],[21,'KY'],[22,'LA'],[23,'ME'],[24,'MD'],
      [25,'MA'],[26,'MI'],[27,'MN'],[28,'MS'],[29,'MO'],[30,'MT'],[31,'NE'],[32,'NV'],[33,'NH'],[34,'NJ'],
      [35,'NM'],[36,'NY'],[37,'NC'],[38,'ND'],[39,'OH'],[40,'OK'],[41,'OR'],[42,'PA'],[44,'RI'],[45,'SC'],
      [46,'SD'],[47,'TN'],[48,'TX'],[49,'UT'],[50,'VT'],[51,'VA'],[53,'WA'],[54,'WV'],[55,'WI'],[56,'WY']
    ]);
    function fips2code(id){ return FIPS2USPS.get(+id) || null; }

    // Pearson correlation
    function pearson(x, y){
      const n = Math.min(x.length, y.length);
      if (n < 3) return NaN;
      const mx = d3.mean(x), my = d3.mean(y);
      const sx = d3.deviation(x) || 0, sy = d3.deviation(y) || 0;
      if (sx === 0 || sy === 0) return NaN;
      let cov = 0; for (let i=0;i<n;i++) cov += (x[i]-mx)*(y[i]-my);
      return cov / ((n-1)*sx*sy);
    }

    // Draw one map (container + values + color scale)
    function drawMap(containerId, values, scale, formatter, titleFor, otherValueFor){
      const wrap = d3.select(containerId);
      const svg = wrap.select('svg')
        .attr('viewBox', `0 0 ${width} ${height}`)
        .attr('preserveAspectRatio','xMidYMid meet');

      d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(us => {
        const states = topojson.feature(us, us.objects.states).features;
        const mesh = topojson.mesh(us, us.objects.states, (a,b)=>a!==b);

        const vals = Array.from(values.values()).filter(Number.isFinite);
        const min = d3.min(vals), max = d3.max(vals), med = d3.median(vals);
        scale.domain([min, max]);

        if (containerId.includes('veg')){
          d3.select('#veg-min').text(formatter(min));
          d3.select('#veg-mid').text(formatter(med));
          d3.select('#veg-max').text(formatter(max));
        } else {
          d3.select('#mob-min').text(formatter(min));
          d3.select('#mob-mid').text(formatter(med));
          d3.select('#mob-max').text(formatter(max));
        }

        svg.selectAll('.state')
          .data(states)
          .join('path')
          .attr('class','state')
          .attr('d', path)
          .attr('fill', d => {
            const code = d.properties?.code || fips2code(d.id);
            const v = values.get(code);
            return Number.isFinite(v) ? scale(v) : '#ddd';
          })
          .on('mousemove', (event, d) => {
            const code = d.properties?.code || fips2code(d.id);
            const v = values.get(code);
            const other = otherValueFor ? otherValueFor(code) : undefined;
            const label = stateMap.get(code) || '—';
            const lines = [
              `<b>${label}</b>`,
              `${titleFor}: <b>${Number.isFinite(v) ? formatter(v) : 'N/A'}</b>`
            ];
            if (other) lines.push(`${other.label}: <b>${Number.isFinite(other.value) ? other.format(other.value) : 'N/A'}</b>`);
            $tip.html(lines.join('<br/>'))
               .style('left', (event.clientX)+'px')
               .style('top', (event.clientY)+'px')
               .style('display','block');
            d3.selectAll(`[data-code="${code}"]`).raise().attr('stroke-width',2).attr('stroke-opacity',.95);
          })
          .on('mouseleave', () => {
            $tip.style('display','none');
            d3.selectAll('.state').attr('stroke-width',.6).attr('stroke-opacity',.4);
          })
          .attr('data-code', d => d.properties?.code || fips2code(d.id));

        svg.append('path')
          .attr('d', path(mesh))
          .attr('fill','none').attr('stroke','#2c1810')
          .attr('stroke-opacity',.5).attr('stroke-width',.7);
      });
    }

    // Load CSVs (fallback to inline demo data if not found)
    Promise.allSettled([
      d3.csv(paths.vegetationCSV),
      d3.csv(paths.mobilityCSV)
    ]).then(([vegRes, mobRes]) => {
      const vegRows = vegRes.status === 'fulfilled' && vegRes.value.length ? vegRes.value : fallbackVeg;
      const mobRows = mobRes.status === 'fulfilled' && mobRes.value.length ? mobRes.value : fallbackMob;

      const vegMap = new Map();
      vegRows.forEach(r => {
        const code = normalizeState(r.state);
        const val  = +r.vegetation;
        if (code && Number.isFinite(val)) vegMap.set(code, val);
      });

      const mobMap = new Map();
      mobRows.forEach(r => {
        const code = normalizeState(r.state);
        const val  = +r.mobility;
        if (code && Number.isFinite(val)) mobMap.set(code, val);
      });

      // Correlation across shared states
      const shared = Array.from(vegMap.keys()).filter(k => mobMap.has(k));
      const xs = shared.map(k => vegMap.get(k));
      const ys = shared.map(k => mobMap.get(k));
      const r = pearson(xs, ys);
      d3.select('#corr').text(Number.isFinite(r) ? (r>=0?'+':'')+r.toFixed(2) : 'N/A');

      // Formatters
      const fmtVeg = v => d3.format('.2f')(v);  // NDVI 0–1
      const fmtMob = v => d3.format(',.0f')(v); // rank 0–100

      // Draw maps with cross-tooltips
      drawMap('#map-veg', vegMap, colorVeg.copy(), fmtVeg, 'Vegetation',
              code => ({label:'Mobility', value: mobMap.get(code), format: fmtMob}));
      drawMap('#map-mob', mobMap, colorMob.copy(), fmtMob, 'Mobility',
              code => ({label:'Vegetation', value: vegMap.get(code), format: fmtVeg}));
    });
  </script>
</body>
</html>